<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
</head>
<body>
    <textarea id="chat-log" cols="100" rows="20"></textarea><br>
    <input id="chat-message-input" type="text" size="100"><br>
    <input id="chat-message-submit" type="button" value="Send">
    {{ room_name|json_script:"room-name" }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const roomNameElement = document.getElementById('room-name');
        if (!roomNameElement) {
            console.error("Room name element not found");
            return;
        }

        let roomName;
        try {
            roomName = JSON.parse(roomNameElement.textContent);
        } catch (e) {
            console.error("Failed to parse room name JSON:", e);
            alert("Invalid room name. Please go back and try again.");
            window.location.href = '/';
            return;
        }

        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/' + encodeURIComponent(roomName) + '/'
        );

        chatSocket.onmessage = function(e) {
            let data;
            try {
                data = JSON.parse(e.data);
            } catch (err) {
                console.error("Received malformed JSON from server:", err, e.data);
                return; // Ignore malformed message
            }

            if (data && data.message) {
                document.querySelector('#chat-log').value += (data.message + '\n');
            } else {
                console.warn("Received unexpected message format:", data);
            }
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');

            // Show a user-friendly message in the chat UI
            const chatLog = document.querySelector('#chat-log');
            if (chatLog) {
                chatLog.value += "\n⚠️ Connection to the chat server was lost. Please refresh the page or try again later.\n";
            } else {
                alert("⚠️ Connection to the chat server was lost. Please refresh the page.");
            }
        };

        const messageInput = document.querySelector('#chat-message-input');
        const messageSubmit = document.querySelector('#chat-message-submit');

        messageInput.focus();

        // Pressing Enter triggers send
        messageInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                messageSubmit.click();
            }
        });

        messageSubmit.addEventListener('click', function() {
            let message = messageInput.value.trim();

            if (!message) {
                alert("Cannot send an empty message.");
                return;
            }

            // Disable input and button to prevent sending until acknowledgment
            messageInput.disabled = true;
            messageSubmit.disabled = true;

            try {
                chatSocket.send(JSON.stringify({
                    'message': message
                }));
                messageInput.value = '';
            } catch (err) {
                console.error("Failed to send message:", err);
                alert("Message could not be sent. Please try again.");
                // Re-enable on failure
                messageInput.disabled = false;
                messageSubmit.disabled = false;
            }
        });

        // When server responds with a new message, re-enable input and button
        chatSocket.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                document.querySelector('#chat-log').value += (data.message + '\n');
            } catch (err) {
                console.error("Malformed message received:", err);
                alert("Received invalid data from server.");
            } finally {
                // Always re-enable input & button after response
                messageInput.disabled = false;
                messageSubmit.disabled = false;
                messageInput.focus();
            }
        };
    });
    </script>
</body>
</html>
